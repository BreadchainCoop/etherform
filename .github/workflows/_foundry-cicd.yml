# All-in-one Foundry CI/CD reusable workflow (orchestrator)
# Usage: jobs.<job>.uses: BreadchainCoop/etherform/.github/workflows/_foundry-cicd.yml@main
#
# This is the main entry point that orchestrates all sub-workflows.
# For more granular control, you can import individual workflows:
#   - _foundry-detect-changes.yml - Change detection
#   - _foundry-ci.yml - Build, test, format check
#   - _foundry-upgrade-safety.yml - Upgrade safety validation
#   - _foundry-deploy.yml - Deploy with verification
#   - _foundry-post-mainnet.yml - Flatten snapshots and create release
name: Foundry CI/CD

on:
  workflow_call:
    inputs:
      # Change Detection Options
      skip-if-no-changes:
        description: 'Skip workflow if no smart contract files changed'
        type: boolean
        default: true
      contract-paths:
        description: 'Paths to check for changes (newline-separated glob patterns)'
        type: string
        default: |
          src/**
          script/**
          test/**
          lib/**
          foundry.toml
          remappings.txt

      # CI Options
      check-formatting:
        description: 'Run forge fmt --check'
        type: boolean
        default: true
      test-verbosity:
        description: 'Test verbosity level (v, vv, vvv, vvvv)'
        type: string
        default: 'vvv'

      # Upgrade Safety Options
      run-upgrade-safety:
        description: 'Run upgrade safety validation'
        type: boolean
        default: true
      baseline-path:
        description: 'Path to baseline contracts for upgrade comparison'
        type: string
        default: 'test/upgrades/baseline'

      # Deploy Options
      deploy-on-pr:
        description: 'Deploy to testnet on pull request'
        type: boolean
        default: false
      deploy-on-main:
        description: 'Deploy to mainnet on push to main'
        type: boolean
        default: false
      deploy-script:
        description: 'Path to deployment script'
        type: string
        default: 'script/Deploy.s.sol:Deploy'
      testnet-blockscout-url:
        description: 'Blockscout URL for testnet verification and explorer links'
        type: string
        default: 'https://eth-sepolia.blockscout.com'
      testnet-name:
        description: 'Testnet network name for display'
        type: string
        default: 'Sepolia'
      mainnet-blockscout-url:
        description: 'Blockscout URL for mainnet verification and explorer links'
        type: string
        default: 'https://eth-sepolia.blockscout.com'
      mainnet-name:
        description: 'Mainnet network name for display'
        type: string
        default: 'Sepolia'
      indexing-wait:
        description: 'Seconds to wait for indexer before verification'
        type: number
        default: 60
      flatten-contracts:
        description: 'Flatten and commit contract snapshots after mainnet deploy'
        type: boolean
        default: true
      init-baseline-without-deploy:
        description: 'Initialize baseline on merge to main even if deploy-on-main is disabled'
        type: boolean
        default: false
      upgrades-path:
        description: 'Path for flattened contract snapshots'
        type: string
        default: 'test/upgrades'

      # Release Options
      create-release:
        description: 'Create GitHub release after deployment'
        type: boolean
        default: true
      release-prefix:
        description: 'Prefix for release tags (e.g., "v" for v1.0.0 style)'
        type: string
        default: ''

      # Working Directory
      working-directory:
        description: 'Working directory for Foundry commands'
        type: string
        default: '.'

    secrets:
      PRIVATE_KEY:
        description: 'Deployer wallet private key'
        required: false
      RPC_URL:
        description: 'Network RPC endpoint'
        required: false
      GH_TOKEN:
        description: 'GitHub token for pushing commits'
        required: false

jobs:
  # ─────────────────────────────────────────────────────────────────────────────
  # Change Detection
  # ─────────────────────────────────────────────────────────────────────────────
  detect-changes:
    uses: BreadchainCoop/etherform/.github/workflows/_foundry-detect-changes.yml@main
    with:
      skip-if-no-changes: ${{ inputs.skip-if-no-changes }}
      contract-paths: ${{ inputs.contract-paths }}
      working-directory: ${{ inputs.working-directory }}

  # ─────────────────────────────────────────────────────────────────────────────
  # CI: Build & Test
  # ─────────────────────────────────────────────────────────────────────────────
  ci:
    needs: [detect-changes]
    if: needs.detect-changes.outputs.should-run == 'true'
    uses: BreadchainCoop/etherform/.github/workflows/_foundry-ci.yml@main
    with:
      check-formatting: ${{ inputs.check-formatting }}
      test-verbosity: ${{ inputs.test-verbosity }}
      working-directory: ${{ inputs.working-directory }}

  # ─────────────────────────────────────────────────────────────────────────────
  # Upgrade Safety Validation
  # ─────────────────────────────────────────────────────────────────────────────
  upgrade-safety:
    needs: [detect-changes, ci]
    if: |
      needs.detect-changes.outputs.should-run == 'true' &&
      inputs.run-upgrade-safety
    uses: BreadchainCoop/etherform/.github/workflows/_foundry-upgrade-safety.yml@main
    with:
      baseline-path: ${{ inputs.baseline-path }}
      upgrades-path: ${{ inputs.upgrades-path }}
      working-directory: ${{ inputs.working-directory }}

  # ─────────────────────────────────────────────────────────────────────────────
  # Testnet Deployment (on PR)
  # ─────────────────────────────────────────────────────────────────────────────
  deploy-testnet:
    needs: [detect-changes, ci, upgrade-safety]
    if: |
      always() &&
      needs.detect-changes.outputs.should-run == 'true' &&
      needs.ci.result == 'success' &&
      (needs.upgrade-safety.result == 'success' || needs.upgrade-safety.result == 'skipped') &&
      inputs.deploy-on-pr &&
      github.event_name == 'pull_request'
    uses: BreadchainCoop/etherform/.github/workflows/_foundry-deploy.yml@main
    with:
      network-type: testnet
      deploy-script: ${{ inputs.deploy-script }}
      blockscout-url: ${{ inputs.testnet-blockscout-url }}
      network-name: ${{ inputs.testnet-name }}
      indexing-wait: ${{ inputs.indexing-wait }}
      pr-number: ${{ github.event.pull_request.number }}
      commit-sha: ${{ github.event.pull_request.head.sha }}
      working-directory: ${{ inputs.working-directory }}
    secrets:
      PRIVATE_KEY: ${{ secrets.PRIVATE_KEY }}
      RPC_URL: ${{ secrets.RPC_URL }}
      GH_TOKEN: ${{ secrets.GH_TOKEN }}

  # ─────────────────────────────────────────────────────────────────────────────
  # Mainnet Deployment (on merge to main)
  # ─────────────────────────────────────────────────────────────────────────────
  deploy-mainnet:
    needs: [detect-changes, ci, upgrade-safety]
    if: |
      always() &&
      needs.detect-changes.outputs.should-run == 'true' &&
      needs.ci.result == 'success' &&
      (needs.upgrade-safety.result == 'success' || needs.upgrade-safety.result == 'skipped') &&
      inputs.deploy-on-main &&
      github.event_name == 'push' &&
      github.ref == 'refs/heads/main'
    uses: BreadchainCoop/etherform/.github/workflows/_foundry-deploy.yml@main
    with:
      network-type: mainnet
      deploy-script: ${{ inputs.deploy-script }}
      blockscout-url: ${{ inputs.mainnet-blockscout-url }}
      network-name: ${{ inputs.mainnet-name }}
      indexing-wait: ${{ inputs.indexing-wait }}
      working-directory: ${{ inputs.working-directory }}
    secrets:
      PRIVATE_KEY: ${{ secrets.PRIVATE_KEY }}
      RPC_URL: ${{ secrets.RPC_URL }}
      GH_TOKEN: ${{ secrets.GH_TOKEN }}

  # ─────────────────────────────────────────────────────────────────────────────
  # Post-Mainnet: Flatten Snapshots & Create Release
  # ─────────────────────────────────────────────────────────────────────────────
  post-mainnet:
    needs: [detect-changes, ci, upgrade-safety, deploy-mainnet]
    if: |
      always() &&
      needs.detect-changes.outputs.should-run == 'true' &&
      needs.ci.result == 'success' &&
      (needs.upgrade-safety.result == 'success' || needs.upgrade-safety.result == 'skipped') &&
      (needs.deploy-mainnet.result == 'success' ||
       (needs.deploy-mainnet.result == 'skipped' && inputs.init-baseline-without-deploy)) &&
      github.event_name == 'push' &&
      github.ref == 'refs/heads/main'
    uses: BreadchainCoop/etherform/.github/workflows/_foundry-post-mainnet.yml@main
    with:
      flatten-contracts: ${{ inputs.flatten-contracts }}
      create-release: ${{ inputs.create-release && needs.deploy-mainnet.result == 'success' }}
      release-prefix: ${{ inputs.release-prefix }}
      upgrades-path: ${{ inputs.upgrades-path }}
      network-name: ${{ inputs.mainnet-name }}
      blockscout-url: ${{ inputs.mainnet-blockscout-url }}
      working-directory: ${{ inputs.working-directory }}
    secrets:
      GH_TOKEN: ${{ secrets.GH_TOKEN }}
